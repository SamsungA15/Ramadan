<script src="quran.js"></script>

<script>
function showPage(id) {
  document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
  const activePage = document.getElementById(id);
  if (activePage) {
    activePage.classList.add("active");
  }
}
window.showPage = showPage;

let count = 0;

function increment() {
  count += 1;
  const countEl = document.getElementById("count");
  if (countEl) {
    countEl.textContent = count;
  }
}
window.increment = increment;

function reset() {
  count = 0;
  const countEl = document.getElementById("count");
  if (countEl) {
    countEl.textContent = "0";
  }
}
window.reset = reset;

function changeTasbeeh(text) {
  const tasbeehText = document.getElementById("tasbeehText");
  if (tasbeehText) {
    tasbeehText.textContent = text;
  }
  reset();
}
window.changeTasbeeh = changeTasbeeh;

const surahSelect = document.getElementById("surahSelect");
const ayahsDiv = document.getElementById("ayahs");

function loadSurah(index) {
  if (!ayahsDiv || !Array.isArray(window.quran) || !window.quran[index]) {
    return;
  }

  ayahsDiv.innerHTML = "";
  window.quran[index].verses.forEach(verse => {
    const ayah = document.createElement("div");
    ayah.className = "ayah";
    ayah.textContent = `${verse.text} ﴿${verse.id}﴾`;
    ayahsDiv.appendChild(ayah);
  });

  ayahsDiv.innerHTML += '<div class="ayah">صدق الله العظيم</div>';
}

if (surahSelect && Array.isArray(window.quran)) {
  window.quran.forEach(surah => {
    const option = document.createElement("option");
    option.value = surah.id - 1;
    option.textContent = surah.name;
    surahSelect.appendChild(option);
  });

  surahSelect.addEventListener("change", event => {
    loadSurah(Number(event.target.value));
  });

  loadSurah(0);
} else if (ayahsDiv) {
  ayahsDiv.innerHTML = '<div class="ayah">تعذر تحميل بيانات القرآن. تأكد من وجود ملف quran.js.</div>';
}

const needle = document.getElementById("needle");
const headingText = document.getElementById("heading");
const compassStatus = document.getElementById("compassStatus");
const enableCompassBtn = document.getElementById("enableCompass");

function updateCompass(angle) {
  if (!needle || !headingText || !compassStatus) {
    return;
  }

  if (typeof angle !== "number" || Number.isNaN(angle)) {
    return;
  }

  const normalized = (angle + 360) % 360;
  needle.style.transform = `rotate(${normalized}deg)`;
  headingText.textContent = `${Math.round(normalized)}°`;
  compassStatus.textContent = "البوصلة تعمل الآن.";
}

function handleOrientation(event) {
  if (event.webkitCompassHeading != null) {
    updateCompass(event.webkitCompassHeading);
    return;
  }

  if (event.alpha != null) {
    updateCompass(360 - event.alpha);
  }
}

function startCompass() {
  window.addEventListener("deviceorientation", handleOrientation, true);
}

if (compassStatus && enableCompassBtn) {
  if (typeof DeviceOrientationEvent !== "undefined" &&
      typeof DeviceOrientationEvent.requestPermission === "function") {
    enableCompassBtn.style.display = "inline-block";
    compassStatus.textContent = "اضغط تفعيل البوصلة للسماح بالوصول إلى المستشعر.";
    enableCompassBtn.addEventListener("click", async () => {
      try {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission === "granted") {
          startCompass();
          enableCompassBtn.style.display = "none";
        } else {
          compassStatus.textContent = "تم رفض إذن المستشعر.";
        }
      } catch {
        compassStatus.textContent = "تعذر تفعيل البوصلة على هذا الجهاز.";
      }
    });
  } else {
    startCompass();
  }
}
</script>
